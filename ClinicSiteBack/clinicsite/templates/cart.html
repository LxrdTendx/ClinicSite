{% load static %}
{% block content %}

<style>
    body{
        /*background: gray;*/
        margin: 0;
        padding: 0;
        zoom: 80%;
        background: var(--main-white, #F5F5F5)
    }
    @media (min-width: 1920px) {
        body {
            zoom: 100%;
        }
    }
    @font-face {
        font-family: 'Gropled';
        src: url('/static/fonts/Gropled-Bold.otf') format('opentype');
        font-weight: 700;
        font-style: normal;
    }
    @font-face {
        font-family: 'TT Fors';
        src: url('/static/fonts/TT Fors Trial Variable.ttf') format('truetype');
        font-weight: 400; /* Normal */
        font-style: normal;
    }

    .header{
        margin-top: 10px;
        margin-right: auto;
        margin-left: auto;
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.10);
        width: 73.75%;
        height: 100px;
        background: var(--main-grey, #232323);
        font-family: Fira Sans Condensed, sans-serif;
        font-size: 18px;
        font-style: normal;
        font-weight: 400;
        line-height: normal;
        position: sticky;
        top: 10px;
        z-index: 10;
        border-radius: 20px;
    }
    .navbar{
        margin-bottom:auto;
        margin-top: auto;
        margin-left: auto;
        margin-right: 80px;
        height: 39px;
        width: auto;
        display: inline-flex;
        justify-content: flex-end;
        align-items: center;
        gap: 20px;
    }
    ul{
        gap: 20px;
        margin: 0;
        width: 100%;
        height: 100%;
        display: flex;
        list-style-type: none;
    }

    ul li{
        width: 95px;

    }
    .logo{
        color: var(--main-white, #F5F5F5);
        font-family: Gropled, sans-serif;
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 100%; /* 32px */
        margin-left: 111px;
        margin-top: auto;
        margin-bottom: auto;
    }
    a{
        text-decoration: none;
        color: white;
    }
    .navbar a, .about-us-link a{
        color: var(--main-light-grey, #585858);
        text-decoration: none;
    }
    .navbar a:hover, .about-us-link a:hover{
        cursor: pointer;
        color: var(--main-grey, #232323);
        transition: 0.5s;
    }
    .main a {
        background-color: var(--main-grey, #232323); /* Фон для 'главная' */
        color: white; /* Цвет текста для 'главная' */
        border-radius: 80px; /* Скругление углов для 'главная' */
        padding: 10px 15px; /* Внутренние отступы для создания обводки */
        display: flex; /* Использование flexbox для центрирования текста */
        align-items: center; /* Центрирование текста по вертикали */
        justify-content: center; /* Центрирование текста по горизонтали */
        width: auto; /* Автоматическая ширина в зависимости от контента и padding */
    }

    /* Стили для остальных пунктов меню */
    .navbar a {
        font-family: "TT Fors", sans-serif;
        color: var(--main-light-grey, #585858);
        display: block;
        text-align: center;
        padding: 10px 15px; /* Одинаковые отступы для всех пунктов */
        border-radius: 80px; /* Скругление углов для всех пунктов */
    }

    /* Стили при наведении для всех пунктов меню */
    .navbar a:hover {
        color: var(--main-grey, #232323);
        background-color: white; /* Фон при наведении */
        text-decoration: none;
    }
    .navbar .active a {

        background-color: white; /* Фон для активного пункта меню */
        color: var(--main-grey, #232323); /* Цвет текста для активного пункта */

    }
    .active{
        background-color: white; /* Фон для активного пункта меню */
        color: var(--main-grey, #232323); /* Цвет текста для активного пункта */
    }
    .footer{
        margin-top: 175px;
        margin-left: auto;
        margin-right: auto;
        height: 200px;
        width: 73.75%;
        margin-bottom: 100px;
    }
    .footer {
        background: #F5F5F5; /* Задайте нужный фон */
        border-radius: 20px;
        border: 1px solid #232323;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .footer-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        /*width: 100%; !* Растягиваем на всю ширину футера *!*/
        gap: 3vw;
    }

    .footer-section {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .footer-heading {
        color: var(--main-grey, #232323);
        font-family: 'TT Fors',sans-serif;
        font-size: 20px;
        font-style: normal;
        font-weight: 600;
        line-height: 100%;
        margin-bottom: 10px; /* Отступ между заголовком и списком */
    }

    .footer-list {
        display: block;
        list-style: none; /* Убираем маркеры списка */
        padding: 0; /* Убираем отступы у списка */
        margin: 0; /* Убираем внешние отступы у списка */
    }

    .footer-item {
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        font-weight: 300;
        color: #232323;
        margin-bottom: 10px; /* Отступ между элементами списка */
    }

    .footer-title.red {
        color: #F22D3E; /* Красный цвет для названия */
        font-family: 'Gropled',sans-serif;
        font-weight: 700;
    }
    .title-page{
        display: flex;
        margin-top: 100px;
        width: 73.75%;
        height: 141px;
        margin-right: auto;
        margin-left: auto;

    }
    .title-page-text{

        height: 141px;
        color: var(--main-grey, #232323);
        leading-trim: both;
        text-edge: cap;
        font-family: Gropled,sans-serif;
        font-size: 72px;
        font-style: normal;
        font-weight: 700;
        line-height: 80%; /* 76.8px */
    }

    .count-of-product{
        margin-top: 14px;
        margin-left: 10px;
        font-family: "TT Fors", sans-serif;
        font-weight: 160;
        font-size: 20px;
        line-height: 100%;
        color: #b5b5b5;
    }

    /* Для медиа запросов и адаптивности */
    @media (max-width: 768px) {
        .footer-content {
            flex-direction: column;
        }

        .footer-section {
            margin-bottom: 20px; /* Отступы между секциями в мобильном виде */
        }
    }
    .footer-phone-select {
        background: #F5F5F5; /* Цвет фона выпадающего списка */
        color: #232323; /* Цвет текста */
        font-size: 16px; /* Размер шрифта */
        cursor: pointer; /* Курсор в виде руки */
        border: none;
    }

    /* Стили для элементов option */
    .footer-phone-select option {
        padding: 5px; /* Отступ для каждого элемента списка */
    }
    .fade {
        animation: fadeIn 2s;
        display: block; /* или другой тип отображения, который вы используете */
    }
    .cart-total{

        margin-left: auto;
        margin-right: auto;
        font-family: "TT Fors", sans-serif;
        font-size: 24px;
        width: 1150px;


    }
    .cart-total table {
        font-size: 24px;
    }
    th, tr{
        font-size: 24px;
    }
    th {
        margin-right: 20px;
    }
    .cart-total table {
        width: 100%; /* Заставляет таблицу растягиваться на всю ширину родительского блока */
        border-collapse: collapse; /* Убирает двойные границы */
    }

    .cart-total th, .cart-total td {
        border: 1px solid #ddd; /* Добавляет границы для ячеек */
        text-align: left; /* Выравнивание текста в ячейках */
        padding: 8px; /* Отступы внутри ячеек */
    }

    .cart-total th {
        background-color: #f2f2f2; /* Цвет фона для заголовков */
    }
    .card-button{
        display: flex;
    }
    .card-button button{
        cursor: pointer;
        justify-content: center;
        height: 26px;
        border-radius: 20px;
        background: var(--main-violet, #A673D8);
        border: none;
        width: 113px;
        color: var(--main-grey, #232323);
        leading-trim: both;
        text-edge: cap;
        font-family: 'TT Fors', sans-serif;
        font-size: 16px;
        font-style: normal;
        font-weight: 280;
        line-height: 100%;
        transition: background-color 0.5s;
        transition: color 0.5s;
    }
    .card-button button:hover{
        background: var(--main-violet, #232323);
        color: var(--main-grey, white);
    }
    .quantity{
        margin-top: 2px;
        font-size: 18px;
        font-family: 'TT Fors', sans-serif;
        display: block;

    }
    .quantity-control{
        display: flex;
        justify-content: space-between;
    }


    .card-button .decrease-quantity{
        width: 27px;
        height: 27px;
        background: #f5f5f5;
        border: 1px solid #b5b5b5;
    }

    .card-button .increase-quantity{
        width: 27px;
        height: 27px;
        background: #f5f5f5;
        border: 1px solid #b5b5b5;
    }

    .card-button .decrease-quantity:hover{
        border: #A673D8;
        background: #A673D8;

    }
    .card-button .increase-quantity:hover{
        border: #A673D8;
        background: #A673D8;

    }
    .cart-total th,
    .cart-total td {
        border: none;
    }
    .cart-total th {
        background-color: transparent;
        font-family: 'Gropled', sans-serif;
        font-weight: 700;
        font-size: 22px;
        line-height: 80%;
        color: #585858;
    }
    .cart-total tr {
        border-bottom: 1px solid #ccc; /* Это добавит горизонтальные линии только между строками */
    }
     .menu__box li .badge {
        display: inline-block;
        background-color: red;
        color: white;
        text-align: center;
        border-radius: 50%;
        width: 21px;
        height: 21px;
        line-height: 21px; /* Для вертикального центрирования текста */
        font-size: 12px;
        font-weight: bold;
        position: relative;
        top: -40px; /* Поднимает кружок над элементом меню */
        left: 40px; /* Сдвигает кружок к правому краю элемента меню */
     }



</style>



<title>Корзина</title>
<div class="header" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="logo">
        <a href=""><img src="">clinic slimness</a>
    </div>
    <div class="navbar">
        <ul class="menu__box">
            <li><a href="{% url 'login' %}">главная</a></li>
            <li><a href="{% url 'market' %}">аптека</a></li>
            <li><a href="{% url 'about' %}">о нас</a></li>
            <li><a class="active" href="{% url 'cart' %}" style="height: 25px">корзина<span class="badge">0</span></a></li>
        </ul>
    </div>
</div>

<div class="title-page">
    <div class="title-page-text">корзина</div>
    <div class="count-of-product">4 товара</div>
</div>



<div class="cart-total" style="width: 73.75%;">
    <table>
        <tr style="font-family: 'Gropled', sans-serif; font-weight: 700; font-size: 22px; line-height: 80%; color: #585858;">
            <th style="width: 10%;">Товар</th>
            <th style="width: 25%;">Название</th>
            <th style="width: 10%;">Цена</th>
            <th style="width: 15%;">Кол-во</th>
            <th style="width: 10%;">Сумма</th>
        </tr>
        {% for item in cart_items %}
        <tr data-product-id="{{ item.product.id }}" style="height: 140px;">
            <td><img src="{{ item.product.photo1.url }}" alt="{{ item.product.name }}" style="width:auto; height: 120px"></td>
            <td>
                <div class="product-name">
                    {{ item.product.brand }}<br>
                    {{ item.product.name }}<br>
                    <div class="text-info">Дозировка: {{ item.product.dosage }}</div>

                </div>
            </td>
            <td class="unit-price">{{ item.unit_price }} ₽</td>
            <td>
                <div class="card-button">
                   <div class="quantity-control" style="width: 100px;">
                        <button class="decrease-quantity" onclick="decreaseQuantity('{{ item.product.id }}')">–</button>
                        <span class="quantity">{{ item.quantity }}</span>
                        <button class="increase-quantity" onclick="increaseQuantity('{{ item.product.id }}')">+</button>
                    </div>
                    <svg onclick="removeItem('{{ item.product.id }}')" style="cursor: pointer; margin-left: 35px" width="26" height="27" viewBox="0 0 19 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M18 3.2H13.6V2C13.6 1.46957 13.3893 0.960859 13.0142 0.585786C12.6391 0.210714 12.1304 0 11.6 0H6.8C6.26957 0 5.76086 0.210714 5.38579 0.585786C5.01071 0.960859 4.8 1.46957 4.8 2V3.2H0.4C0.293913 3.2 0.192172 3.24214 0.117157 3.31716C0.0421428 3.39217 0 3.49391 0 3.6C0 3.70609 0.0421428 3.80783 0.117157 3.88284C0.192172 3.95786 0.293913 4 0.4 4H1.6V18.8C1.6 19.1183 1.72643 19.4235 1.95147 19.6485C2.17652 19.8736 2.48174 20 2.8 20H15.6C15.9183 20 16.2235 19.8736 16.4485 19.6485C16.6736 19.4235 16.8 19.1183 16.8 18.8V4H18C18.1061 4 18.2078 3.95786 18.2828 3.88284C18.3579 3.80783 18.4 3.70609 18.4 3.6C18.4 3.49391 18.3579 3.39217 18.2828 3.31716C18.2078 3.24214 18.1061 3.2 18 3.2ZM5.6 2C5.6 1.68174 5.72643 1.37652 5.95147 1.15147C6.17652 0.926428 6.48174 0.8 6.8 0.8H11.6C11.9183 0.8 12.2235 0.926428 12.4485 1.15147C12.6736 1.37652 12.8 1.68174 12.8 2V3.2H5.6V2ZM16 18.8C16 18.9061 15.9579 19.0078 15.8828 19.0828C15.8078 19.1579 15.7061 19.2 15.6 19.2H2.8C2.69391 19.2 2.59217 19.1579 2.51716 19.0828C2.44214 19.0078 2.4 18.9061 2.4 18.8V4H16V18.8ZM7.2 8.4V14.8C7.2 14.9061 7.15786 15.0078 7.08284 15.0828C7.00783 15.1579 6.90609 15.2 6.8 15.2C6.69391 15.2 6.59217 15.1579 6.51716 15.0828C6.44214 15.0078 6.4 14.9061 6.4 14.8V8.4C6.4 8.29391 6.44214 8.19217 6.51716 8.11716C6.59217 8.04214 6.69391 8 6.8 8C6.90609 8 7.00783 8.04214 7.08284 8.11716C7.15786 8.19217 7.2 8.29391 7.2 8.4ZM12 8.4V14.8C12 14.9061 11.9579 15.0078 11.8828 15.0828C11.8078 15.1579 11.7061 15.2 11.6 15.2C11.4939 15.2 11.3922 15.1579 11.3172 15.0828C11.2421 15.0078 11.2 14.9061 11.2 14.8V8.4C11.2 8.29391 11.2421 8.19217 11.3172 8.11716C11.3922 8.04214 11.4939 8 11.6 8C11.7061 8 11.8078 8.04214 11.8828 8.11716C11.9579 8.19217 12 8.29391 12 8.4Z" fill="#F22D3E" />
                    </svg>
                </div>
            </td>
            <td class="total-price">{{ item.total_price }} ₽</td>
        </tr>
        {% endfor %}

    </table>
    <div id="total-sum">{{ total_sum }} ₽</div>

</div>



<div class="footer">
    <div class="footer-content">
        <div class="footer-section">
            <h2 class="footer-title red">clinic slimness</h2>
        </div>
        <div style="width: 0px;height: 122px; border: 1px #232323 solid"></div>
        <div class="footer-section">
            <h3 class="footer-heading">наши услуги</h3>
            <ul class="footer-list">
                <li class="footer-item">услуга 1</li>
                <li class="footer-item">услуга 2</li>
                <li class="footer-item">услуга 3</li>
            </ul>
        </div>
        <div style="width: 0px; height: 122px; border: 1px #232323 solid"></div>
        <div class="footer-section">
            <h3 class="footer-heading">компания</h3>
            <ul class="footer-list">
                <li class="footer-item">о нас</li>
                <li class="footer-item">аптека</li>
                <li class="footer-item">контакты</li>
            </ul>
        </div>
        <div style="width: 0px;height: 122px; border: 1px #232323 solid"></div>
        <div class="footer-section">
            <h3 class="footer-heading">контакты</h3>
            <ul class="footer-list">
                <li class="footer-item">
                    <!-- Выпадающий список телефонных номеров -->
                    <select class="footer-phone-select" onchange="location = this.value;">
                        <option value="tel:+74956080101">+7 495 608-01-01</option>
                        <option value="tel:+74956077950">+7 495 607-79-50</option>
                        <option value="tel:+74956073701">+7 495 607-37-01</option>
                        <option value="tel:+74955438384">+7 495 543-83-84</option>
                    </select>
                </li>
                <li class="footer-item"><a href="mailto:info@medicsel.ru" style="color:#232323;">info@medicsel.ru</a></li>
                <li class="footer-item" style="width: auto">г. Москва, пер. Малый Козловский, д. 6</li>
            </ul>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (!window.location.search) {  // Проверяем, есть ли уже параметры в URL
        let ids = [];
        let quantities = [];

        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key.startsWith('product_')) {
                let id = key.split('_')[1];
                let quantity = localStorage.getItem(key);

                ids.push(id);
                quantities.push(quantity);
            }
        }

        if (ids.length > 0 && quantities.length > 0) {
            // Перенаправляем пользователя на URL с параметрами товаров
            window.location.href = `${window.location.pathname}?ids=${ids.join(',')}&quantities=${quantities.join(',')}`;
        }
    }
});
</script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    initializeCart();
});


function getProductsText(count) {
    let text = 'товаров'; // Для 0, 5-20 товаров
    if (count % 10 === 1 && count % 100 !== 11) {
        text = 'товар'; // Для 1 товар
    } else if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) {
        text = 'товара'; // Для 2-4 товара
    }
    return `${count} ${text}`;
}
function getCartCount() {
    const params = new URLSearchParams(window.location.search);
    const ids = params.get('ids');
    if (!ids) {
        return 0;
    }
    // Разделяем строку ID на массив и считаем количество элементов
    return ids.split(',').length;
}

function updateProductCount() {
    const count = getCartCount(); // Получаем количество товаров в корзине
    const countElement = document.querySelector('.count-of-product');
    const badgeElements = document.querySelectorAll('.badge');

    // Обновляем текст в .count-of-product
    if (countElement) {
        countElement.textContent = getProductsText(count);
    }

    // Обновляем и скрываем .badge в зависимости от количества товаров
    badgeElements.forEach(badge => {
        if (count > 0) {
            badge.textContent = count; // Устанавливаем текст равным количеству товаров
            badge.style.display = 'inline-block'; // Показываем .badge
        } else {
            badge.style.display = 'none'; // Скрываем .badge, если товаров нет
        }
    });
}

document.addEventListener('DOMContentLoaded', updateProductCount);

function initializeCart() {
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const productId = row.dataset.productId;
        const storedQuantity = parseInt(localStorage.getItem(`product_${productId}`) || "0");

        if (storedQuantity > 0) {
            const quantitySpan = row.querySelector('.quantity');
            quantitySpan.innerText = storedQuantity;

            // Обновляем сумму для этого продукта
            const unitPrice = parseFloat(row.querySelector('.unit-price').innerText.replace('₽', ''));
            const totalPriceElement = row.querySelector('.total-price');
            totalPriceElement.innerText = `${unitPrice * storedQuantity} ₽`;
        } else {
            // Если количество равно нулю, удаляем строку из таблицы
            row.remove();
        }
    });

    // Обновляем итоговую сумму после инициализации
    updateTotalSum();
}
function removeItem(productId) {
    const row = document.querySelector(`tr[data-product-id="${productId}"]`);
    if (row) {
        row.remove(); // Удалить строку товара из таблицы
        localStorage.removeItem(`product_${productId}`); // Удалить товар из localStorage
        updateTotalSum(); // Обновить итоговую сумму
        updateURLAndLocalStorageAfterRemoval(productId);
        updateProductCount();
    }
}
function updateURLAndLocalStorageAfterRemoval(productId) {
    // Здесь должен быть ваш код для обновления localStorage или URL
    // Этот код зависит от вашей текущей реализации управления корзиной

    // Пример обновления параметров URL
    const params = new URLSearchParams(window.location.search);
    let ids = params.get('ids').split(',');
    let quantities = params.get('quantities').split(',');

    const index = ids.indexOf(productId.toString());
    if (index > -1) {
        ids.splice(index, 1);
        quantities.splice(index, 1);
    }

    params.set('ids', ids.join(','));
    params.set('quantities', quantities.join(','));

    // Обновление URL без перезагрузки страницы
    history.replaceState(null, '', `${location.pathname}?${params}`);
}
function updateQuantityControl(productId, quantity) {
    const row = document.querySelector(`tr[data-product-id="${productId}"]`);

    if (quantity > 0) {
        const quantitySpan = row.querySelector('.quantity');
        quantitySpan.innerText = quantity;
        localStorage.setItem(`product_${productId}`, quantity);

        // Обновляем сумму для этого продукта
        const unitPrice = parseFloat(row.querySelector('.unit-price').innerText.replace('₽', ''));
        const totalPriceElement = row.querySelector('.total-price');
        totalPriceElement.innerText = `${unitPrice * quantity} ₽`;

        // Обновляем итоговую сумму
        updateTotalSum();
    } else {
        localStorage.removeItem(`product_${productId}`);
        row.remove(); // Удалить строку товара из таблицы

        // Обновляем итоговую сумму после удаления элемента
        updateTotalSum();
    }
}

function updateTotalSum() {
    const totalSumElement = document.querySelector('#total-sum'); // Убедитесь, что у вас есть элемент с этим ID
    let totalSum = 0;
    document.querySelectorAll('.total-price').forEach((element) => {
        totalSum += parseFloat(element.innerText.replace('₽', ''));
    });
    totalSumElement.innerText = `${totalSum} ₽`;
}

function increaseQuantity(productId) {
    let quantity = parseInt(localStorage.getItem(`product_${productId}`) || "0");
    updateQuantityControl(productId, ++quantity);
}

function decreaseQuantity(productId) {
    let quantity = parseInt(localStorage.getItem(`product_${productId}`));
    if (quantity > 1) {
        updateQuantityControl(productId, --quantity);
    } else {
        localStorage.removeItem(`product_${productId}`);
        const row = document.querySelector(`tr[data-product-id="${productId}"]`);
        if (row) {
            row.remove(); // Удалить строку товара из таблицы
        }
        // Обновляем итоговую сумму и количество товаров после удаления элемента
        updateTotalSum();
        updateURLAndLocalStorageAfterRemoval(productId); // Убедитесь, что эта функция обновляет параметры URL
        updateProductCount();
    }
}
</script>

{% endblock %}